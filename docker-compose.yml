# specify what services we want to run when the compose file is called
services:
  # MongoDB Database Service
  mongo:
    image: mongo:latest
    container_name: payment_portal_db
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=payment_portal
    networks:
      - payment_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # here we define the options to run our API
  library_api:
    # when running, we tell it to rebuild the image in case of any changes
    build:
      # here we tell it where to build from
      context: ./backend
    
    # we tell it to expose these ports
    ports:
      # HTTP port
      - "3000:3000"
      # HTTPS port
      - "3443:3443"
    environment:
      - NODE_ENV=development
      - CONN_STRING=mongodb://mongo:27017/payment_portal
    networks:
      - payment_network
    depends_on:
      mongo:
        condition: service_healthy

  library_frontend:
    build:
      context: ./frontend
    ports:
      # HTTPS port for frontend (Vite will use this)
      - "5173:5173"
    networks:
      - payment_network
    # specify what we need to wait for before running the container
    depends_on:
      # in this instance, we wait until the backend is up and running
      - library_api

# Define volumes for persistent data
volumes:
  mongo_data:

# Define custom network for service communication
networks:
  payment_network:
    driver: bridge
